<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Iniciar sesión - ClicOnTime</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-100 flex items-center justify-center">
    <div
      class="w-full max-w-md bg-white rounded-2xl shadow-lg border border-slate-200 p-8"
    >
    <img 
          src="logo-clicandapp.png" 
          alt="Logo Clic&App" 
          class="mx-auto h-20 mb-2" 
        />
      <div class="text-1xl font-bold text-indigo-400 mb-2">ClicOnTime - Login</div>
    
      <p class="text-sm text-slate-500 mb-6">
        Sistema de fichajes y gestión de jornada.
      </p>
      <!--<h1 class="text-2xl font-semibold text-slate-800 mb-2">Iniciar sesión</h1>
      <p class="text-sm text-slate-500 mb-6">
        Accede para fichar tu jornada y gestionar tus horarios.
      </p>
    -->
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1"
            >Correo electrónico</label
          >
          <input
            id="email"
            type="email"
            required
            class="w-full rounded-xl border-slate-300 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="tuemail@empresa.com"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1"
            >Contraseña</label
          >
          <input
            id="password"
            type="password"
            required
            class="w-full rounded-xl border-slate-300 text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="••••••••"
          />
        </div>

        <div id="errorMsg" class="text-sm text-rose-500 h-5"></div>

        <button
          type="submit"
          class="w-full py-3 rounded-xl font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition disabled:opacity-40 disabled:cursor-not-allowed"
        >
          Entrar
        </button>
      </form>
      <p class="mt-4 text-[11px] text-slate-500 text-center">
        ¿Olvidaste tu contraseña?
        <button
          type="button"
          id="btnOpenResetModal"
          class="text-indigo-600 underline mb-2"
        >
          Restablecer con clave maestra
        </button>
      </p>
          <a
          href="/manuales/Reestablecer.pdf"
          download="Reestablecer.pdf"
          class="text-xs px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100 transition"
        >
          Manual: crear o reestablecer contraseña
        </a>
    </div>

    <script>
      const API_BASE_URL = "/api";

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("loginForm");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const errorMsg = document.getElementById("errorMsg");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          errorMsg.textContent = "";
          form.querySelector('button[type="submit"]').disabled = true;

          try {
            const res = await fetch(API_BASE_URL + "/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: emailInput.value,
                password: passwordInput.value,
              }),
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              errorMsg.textContent = data.message || "Error al iniciar sesión";
              form.querySelector('button[type="submit"]').disabled = false;
              return;
            }

            // Guardamos token y datos de usuario
            // Guardamos token y datos de usuario
            localStorage.setItem("authToken", data.token);
            localStorage.setItem("userInfo", JSON.stringify(data.user));

            // Redirigir según rol
            if (data.user.role === "WORKER") {
              window.location.href = "/worker-dashboard.html";
            } else if (data.user.role === "CLIENT_ADMIN") {
              window.location.href = "/admin-workers.html";
            } else if (data.user.role === "SUPER_ADMIN") {
              window.location.href = "/super-companies.html";
            } else {
              window.location.href = "/worker-dashboard.html";
            }
          } catch (err) {
            console.error(err);
            errorMsg.textContent = "No se pudo conectar con el servidor";
            form.querySelector('button[type="submit"]').disabled = false;
          }
        });
        // --- Reset con clave maestra ---
        const resetModal = document.getElementById("resetModal");
        const btnOpenResetModal = document.getElementById("btnOpenResetModal");
        const btnCloseResetModal =
          document.getElementById("btnCloseResetModal");
        const btnCancelReset = document.getElementById("btnCancelReset");
        const btnDoReset = document.getElementById("btnDoReset");

        function openResetModal() {
          if (resetModal) resetModal.classList.remove("hidden");
        }
        function closeResetModal() {
          if (resetModal) resetModal.classList.add("hidden");
        }

        if (btnOpenResetModal) {
          btnOpenResetModal.addEventListener("click", openResetModal);
        }
        if (btnCloseResetModal) {
          btnCloseResetModal.addEventListener("click", closeResetModal);
        }
        if (btnCancelReset) {
          btnCancelReset.addEventListener("click", closeResetModal);
        }

        if (btnDoReset) {
          btnDoReset.addEventListener("click", async () => {
            const email = document.getElementById("resetEmail").value.trim();
            const newPassword = document
              .getElementById("resetNewPassword")
              .value.trim();
            const masterKey = document
              .getElementById("resetMasterKey")
              .value.trim();

            if (!email || !newPassword || !masterKey) {
              alert("Completa email, nueva contraseña y clave maestra.");
              return;
            }

            try {
              const res = await fetch(API_BASE_URL + "/auth/master-reset", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, newPassword, masterKey }),
              });

              const data = await res.json().catch(() => ({}));

              if (!res.ok) {
                alert(data.message || "Error al restablecer la contraseña.");
                return;
              }

              alert(
                "Contraseña actualizada. Ahora puedes iniciar sesión con la nueva contraseña."
              );
              closeResetModal();
            } catch (err) {
              console.error(err);
              alert("Error de conexión al restablecer la contraseña.");
            }
          });
        }
      });
    </script>
    <!-- Modal reset con clave maestra -->
    <div
      id="resetModal"
      class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-slate-800">
            Restablecer contraseña
          </h3>
          <button
            type="button"
            id="btnCloseResetModal"
            class="text-slate-400 hover:text-slate-600 text-xl leading-none"
          >
            ×
          </button>
        </div>

        <div class="space-y-3 text-xs">
          <div>
            <label class="block mb-1 text-slate-600">Email</label>
            <input
              id="resetEmail"
              type="email"
              class="w-full rounded-xl border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div>
            <label class="block mb-1 text-slate-600">Nueva contraseña</label>
            <input
              id="resetNewPassword"
              type="password"
              class="w-full rounded-xl border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div>
            <label class="block mb-1 text-slate-600">Clave maestra</label>
            <input
              id="resetMasterKey"
              type="password"
              class="w-full rounded-xl border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
            <p class="mt-1 text-[10px] text-slate-400">
              Usa la clave maestra correspondiente (empleado, empresa o super
              admin).
            </p>
          </div>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button
            type="button"
            id="btnCancelReset"
            class="px-3 py-2 rounded-xl text-[11px] font-semibold text-slate-600 border border-slate-300 hover:bg-slate-50"
          >
            Cancelar
          </button>
          <button
            type="button"
            id="btnDoReset"
            class="px-4 py-2 rounded-xl text-[11px] font-semibold text-white bg-indigo-600 hover:bg-indigo-700"
          >
            Restablecer
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
